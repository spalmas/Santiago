---
title: "Analysis of Santiago Urban Individual Tree Growth"
author: "spp"
date: "`r format(Sys.time(), '%d %B, %Y')`"
---

Script to fit DAP, BA and Biomass growth model per species or classification of species
The arboles_ growth.xls file is generated from first part of Santiago_ LandUse_Trees.Rmd

#### Reading Data
```{r Reading data and , eval=TRUE, message=FALSE}
require(dplyr)
#Set working directory
#setwd("~/Google Drive/Urban")
#For Windows
setwd("C:/Users/Sebastian/Google Drive/Urban")

#Reading Data
arboles_growth <- read.csv("Data/arboles_growth.csv")
```

#### Tree growth statistical analysis by classes
```{r Statistics by classes, eval=TRUE, message=FALSE}
require(lme4)
require(multcomp)

#Set working directory
#setwd("~/Google Drive/Urban")
#For Windows
setwd("C:/Users/Sebastian/Google Drive/Urban")


#Fitting models for DBH, BA and Biomass growth per species. Randomizing stuff. Only for grouped categories
fitGrowthDBH_class <- lmer(DBH.02.12 ~ Class + (1|Land.Use.Description_grouped), data=arboles_growth)
summary(fitGrowthDBH_class)
fitGrowthBA_class <- lmer(BA.02.12   ~ Class + (1|Land.Use.Description_grouped), data=arboles_growth)
summary(fitGrowthBA_class)
fitGrowthBiomass_class <- lmer(Biomass.02.14 ~ Class + (1|Land.Use.Description_grouped), data=arboles_growth)
summary(fitGrowthBiomass_class)


#Plots
aovGrowthDBH_class  = aov(DBH.02.12 ~ Class , data=arboles_growth)
aovGrowthBA_class  = aov(BA.02.12 ~ Class , data=arboles_growth)
aovGrowthBiomass_class  = aov(Biomass.02.14 ~ Class , data=arboles_growth)
par(mfrow = c(1,3))
plot(cld(glht(aovGrowthDBH_class,linfct=mcp(Class='Tukey'))),
     main = 'DBH Growth per species Class', las = 3)
plot(cld(glht(aovGrowthBA_class,linfct=mcp(Class='Tukey'))),
     main = 'Basal Area Growth per species Class', las = 3)
plot(cld(glht(aovGrowthBiomass_class,linfct=mcp(Class='Tukey'))),
     main = 'Biomasa Growth per species Class', las = 3)

#Code to get summary means for BA and BIomass growth per class
se <- function(x) sqrt(var(x)/length(x))
model.tables(aovGrowthDBH_class, "means", se = TRUE)
aggregate(arboles_growth$DBH.02.12, by=list(arboles_growth$Class), FUN=se)
model.tables(aovGrowthBA_class, "means", se = TRUE)
aggregate(arboles_growth$BA.02.12, by=list(arboles_growth$Class), FUN=se)
model.tables(aovGrowthBiomass_class, "means", se = TRUE)
aggregate(arboles_growth$Biomass.02.14, by=list(arboles_growth$Class), FUN=se)

```

```{r Exporting plots by Class, eval=TRUE, message=FALSE, echo = FALSE, warnings = FALSE}
#### To export graphs to files by classes
#Set working directory
#setwd("~/Google Drive/Urban")
#For Windows
setwd("C:/Users/Sebastian/Google Drive/Urban")

#DBH and BA Growth per species (only for those with high number of samples)
par(mfrow = c(1,2))
png("Analysis/Plots/GrowthDBH-BA_Class.png")
plot(cld(glht(aovGrowthDBH_class,linfct=mcp(Class='Tukey'))), las = 3)
plot(cld(glht(aovGrowthBA_class,linfct=mcp(Class='Tukey'))), las = 3)
dev.off()
```

```{r Trash code, eval=FALSE, echo=FALSE}

#Choosing only the species with many smamples
spp_for_growth = c('Robinia pseudoacacia', 
                   'Prunus ceracifera',
                   'Acer negundo', 
                   'Prunus amygdalus', 
                   'Citrus limon')
arboles_growth_reduced = arboles_growth[arboles_growth$Specie %in% spp_for_growth,]


#Fitting models for DBH, BA and Biomass growth per species. Randomizing stuff. Only for grouped categories
fitGrowthDBH <- lmer(DBH.02.12 ~ Specie + (1|Land.Use.Description_grouped), data=arboles_growth_reduced)
summary(fitGrowthDBH)
fitGrowthBA <- lmer(BA.02.12   ~ Specie + (1|Land.Use.Description_grouped), data=arboles_growth_reduced)
summary(fitGrowthBA)
fitGrowthBiomass <- lmer(Biomass.02.14 ~ Specie+ (1|Land.Use.Description_grouped), data=arboles_growth_reduced)
summary(fitGrowthBiomass)


#Plots
aovGrowthDBH  = aov(DBH.02.12 ~ Specie , data=arboles_growth_reduced)
aovGrowthBA  = aov(BA.02.12 ~ Specie , data=arboles_growth_reduced)
aovGrowthBiomass  = aov(Biomass.02.14 ~ Specie , data=arboles_growth_reduced)
par(mfrow = c(1,3))
plot(cld(glht(aovGrowthDBH,linfct=mcp(Specie='Tukey'))),
     main = 'DBH Growth per species', las = 3)
plot(cld(glht(aovGrowthBA,linfct=mcp(Specie='Tukey'))),
     main = 'Basal Area Growth per species', las = 3)
plot(cld(glht(aovGrowthBiomass,linfct=mcp(Specie='Tukey'))),
     main = 'Biomasa Growth per species', las = 3)

par(mfrow = c(1,2))
png("Analysis/Plots/GrowthBA-DBH.png")
plot(cld(glht(aovGrowthDBH,linfct=mcp(Specie='Tukey'))),
     las = 3)
plot(cld(glht(aovGrowthBA,linfct=mcp(Specie='Tukey'))),
     las = 3)
dev.off()
```